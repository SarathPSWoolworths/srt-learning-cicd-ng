# =============================================================================
# Deployment Pipeline - Deploy to Production
# =============================================================================
#
# This workflow handles:
# - Manual trigger for PROD deployment
# - Multi-level approval (QA + Management)
# - Building with PROD environment configuration
# - Deployment to production environment
# - Post-deployment verification
#
# Trigger: Manual workflow dispatch
# Environment: PROD (requires QA + Management approval)
# =============================================================================

name: ğŸš€ Deploy to PROD

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (must be tested in UAT)'
        required: true
        type: string
      change_ticket:
        description: 'Change management ticket number (e.g., CHG-12345)'
        required: true
        type: string
      deployment_window:
        description: 'Deployment window'
        required: true
        type: choice
        options:
          - 'Standard (Business Hours)'
          - 'After Hours (6 PM - 10 PM)'
          - 'Weekend'
          - 'Emergency'
      rollback_plan:
        description: 'Rollback plan confirmed?'
        required: true
        type: boolean
        default: false

env:
  NODE_VERSION: '20.x'
  DEPLOYMENT_PLATFORM: 'github-pages'

jobs:
  # ===========================================================================
  # Job: Pre-deployment Checks
  # ===========================================================================
  pre-deployment-checks:
    name: ğŸ” Pre-deployment Checks
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.validate.outputs.version }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âœ… Validate inputs
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          VERSION="${VERSION#v}"

          echo "ğŸ” Running pre-deployment checks..."
          echo ""

          # Check 1: Version tag exists
          echo "Check 1: Validating version tag..."
          if git tag -l "v${VERSION}" | grep -q "v${VERSION}"; then
            echo "  âœ… Version tag v${VERSION} exists"
          else
            echo "  âŒ Version tag v${VERSION} not found"
            exit 1
          fi

          # Check 2: Change ticket provided
          echo "Check 2: Validating change ticket..."
          if [[ "${{ inputs.change_ticket }}" =~ ^CHG-[0-9]+$ ]]; then
            echo "  âœ… Valid change ticket: ${{ inputs.change_ticket }}"
          else
            echo "  âš ï¸ Change ticket format may be invalid: ${{ inputs.change_ticket }}"
            echo "  (Expected format: CHG-12345)"
          fi

          # Check 3: Rollback plan
          echo "Check 3: Rollback plan..."
          if [[ "${{ inputs.rollback_plan }}" == "true" ]]; then
            echo "  âœ… Rollback plan confirmed"
          else
            echo "  âŒ Rollback plan must be confirmed"
            exit 1
          fi

          echo ""
          echo "âœ… All pre-deployment checks passed"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Pre-deployment summary
        run: |
          echo "## ğŸ” Pre-deployment Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version Tag | âœ… v${{ steps.validate.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Change Ticket | âœ… ${{ inputs.change_ticket }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Window | âœ… ${{ inputs.deployment_window }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rollback Plan | âœ… Confirmed |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job: QA Approval Gate
  # ===========================================================================
  qa-approval:
    name: ğŸ” QA Team Approval
    runs-on: ubuntu-latest
    needs: pre-deployment-checks

    # Configure QA reviewers in: Settings > Environments > PROD-QA-Approval
    # Set required reviewers for PROD-QA-Approval in GitHub UI (Settings > Environments)
    environment:
      name: PROD-QA-Approval

    steps:
      - name: âœ… QA Approval granted
        run: |
          echo "## âœ… QA Team Approval" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Approved by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job: Management Approval Gate
  # ===========================================================================
  management-approval:
    name: ğŸ” Management Approval
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, qa-approval]

    # Configure Management reviewers in: Settings > Environments > PROD-Management-Approval
    # Set required reviewers for PROD-Management-Approval in GitHub UI (Settings > Environments)
    environment:
      name: PROD-Management-Approval

    steps:
      - name: âœ… Management Approval granted
        run: |
          echo "## âœ… Management Approval" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Approved by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job: Build for Production
  # ===========================================================================
  build-prod:
    name: ğŸ”¨ Build for Production
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, qa-approval, management-approval]

    steps:
      - name: ğŸ•µï¸â€â™‚ï¸ Print version from environment file
        run: |
          echo "PROD environment version: $(grep version src/environments/environment.prod.ts)"

      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.pre-deployment-checks.outputs.version }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ“ Update version and environment name in environment files
        run: |
          VERSION="${{ needs.pre-deployment-checks.outputs.version }}"
          sed -i "s/\${VERSION}/${VERSION}/g" src/environments/environment.prod.ts
          sed -i "s/name: '.*'/name: 'PROD'/g" src/environments/environment.prod.ts

      - name: ğŸ—ï¸ Build for Production
        run: |
          npm run build -- --configuration=production --base-href="/srt-learning-cicd-ng/"
      - name: ğŸ“¤ Prepare PROD artifact for GitHub Pages
        run: |
          mkdir -p github-pages-artifact
          cp -r dist/srt-learning-cicd-ng/browser/* github-pages-artifact/
      - name: ğŸ“¤ Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages-artifact
          path: github-pages-artifact

  # ===========================================================================
  # Job: Deploy to Production
  # ===========================================================================
  deploy-prod:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, build-prod]

    permissions:
      contents: read
      pages: write
      id-token: write

    # Set required reviewers for PROD in GitHub UI (Settings > Environments)
    environment:
      name: PROD
      url: https://${{ github.repository_owner }}.github.io/srt-learning-cicd-ng/
        echo "**PROD URL:** https://${{ github.repository_owner }}.github.io/srt-learning-cicd-ng/" >> $GITHUB_STEP_SUMMARY

    steps:
      - name: ğŸ“¥ Download PROD artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages-artifact
          path: github-pages-artifact
      - name: ğŸ“„ Setup Pages
        uses: actions/configure-pages@v4
      - name: ğŸ“¤ Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: github-pages-artifact
      - name: ğŸŒ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # GCP deployment (placeholder)
      - name: ğŸŒ Deploy to GCP (placeholder)
        if: env.DEPLOYMENT_PLATFORM == 'gcp'
        run: |
          echo "GCP production deployment steps:"
          echo "1. Authenticate to GCP production project"
          echo "2. Create backup of current deployment"
          echo "3. Upload new version to Cloud Storage"
          echo "4. Update load balancer backend"
          echo "5. Invalidate CDN cache"
          echo "6. Run smoke tests"
          # Uncomment when ready:
          # gcloud auth activate-service-account --key-file=${{ secrets.GCP_SA_KEY_PROD }}
          # gsutil -m rsync -d -r dist gs://${{ vars.GCP_BUCKET_PROD }}

  # ===========================================================================
  # Job: Post-deployment Verification
  # ===========================================================================
  post-deployment:
    name: âœ… Post-deployment Verification
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, deploy-prod]

    steps:
      - name: ğŸ” Verify deployment
        run: |
          echo "Running post-deployment verification..."

          # Wait for deployment to propagate
          sleep 30

          # Health check (adjust URL for your deployment)
          PROD_URL="https://${{ github.repository_owner }}.github.io/srt-learning-cicd-ng/"

          echo "Checking ${PROD_URL}..."

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${PROD_URL}" || echo "000")

          if [[ "${HTTP_STATUS}" == "200" ]]; then
            echo "âœ… Health check passed (HTTP ${HTTP_STATUS})"
          else
            echo "âš ï¸ Health check returned HTTP ${HTTP_STATUS}"
          fi

      - name: ğŸ“‹ Deployment summary
        run: |
          echo "## ğŸ‰ Production Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | v${{ needs.pre-deployment-checks.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | PROD |" >> $GITHUB_STEP_SUMMARY
          echo "| Change Ticket | ${{ inputs.change_ticket }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Window | ${{ inputs.deployment_window }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Time | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Approvals" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… QA Team Approved" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Management Approved" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor application health and metrics" >> $GITHUB_STEP_SUMMARY
          echo "2. Close change ticket: ${{ inputs.change_ticket }}" >> $GITHUB_STEP_SUMMARY
          echo "3. Update release notes" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job: Create Release
  # ===========================================================================
  create-release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, deploy-prod, post-deployment]

    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ Download production artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-prod-${{ needs.pre-deployment-checks.outputs.version }}
          path: dist

      - name: ğŸ“¦ Create release archive
        run: |
          cd dist
          zip -r ../srt-learning-cicd-ng-${{ needs.pre-deployment-checks.outputs.version }}.zip .

      - name: ğŸ“ Generate release notes
        id: release-notes
        run: |
          VERSION="${{ needs.pre-deployment-checks.outputs.version }}"

          cat << EOF > RELEASE_NOTES.md
          # Release v${VERSION}

          ## Deployment Information
          - **Change Ticket:** ${{ inputs.change_ticket }}
          - **Deployment Window:** ${{ inputs.deployment_window }}
          - **Deployed by:** ${{ github.actor }}
          - **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ## Approvals
          - âœ… QA Team
          - âœ… Management

          ## Changes
          See commit history for detailed changes.
          EOF

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.pre-deployment-checks.outputs.version }}
          name: Release v${{ needs.pre-deployment-checks.outputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            srt-learning-cicd-ng-${{ needs.pre-deployment-checks.outputs.version }}.zip
          draft: false
          prerelease: false
