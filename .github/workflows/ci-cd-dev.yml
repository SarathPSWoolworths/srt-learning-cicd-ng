# =============================================================================
# CI/CD Pipeline - Build, Test, and Deploy to DEV
# =============================================================================
#
# This workflow handles:
# - Automatic builds and tests on push/PR to main
# - Automatic deployment to DEV environment on merge to main
# - Semantic versioning with automatic version bumping
# - Artifact creation for downstream deployments
#
# Trigger: Push to main branch or Pull Request
# Environment: DEV (automatic deployment)
# =============================================================================

name: CI/CD Pipeline - Build & Deploy to DEV

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Prevent concurrent deployments
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  # Deployment platform configuration (change this for different platforms)
  DEPLOYMENT_PLATFORM: 'github-pages' # Options: 'github-pages', 'gcp', 'azure', 'aws'

jobs:
  # ===========================================================================
  # Job: Build and Test
  # ===========================================================================
  build-and-test:
    name: üî® Build & Test
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout Repository
      # -----------------------------------------------------------------------
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for versioning

      # -----------------------------------------------------------------------
      # Step 2: Setup Node.js
      # -----------------------------------------------------------------------
      - name: üì¶ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # -----------------------------------------------------------------------
      # Step 3: Install Dependencies
      # -----------------------------------------------------------------------
      - name: üìö Install dependencies
        run: npm ci

      # -----------------------------------------------------------------------
      # Step 4: Run Linting (if available)
      # -----------------------------------------------------------------------
      - name: üîç Run linting
        run: npm run lint --if-present
        continue-on-error: true

      # -----------------------------------------------------------------------
      # Step 5: Run Unit Tests
      # -----------------------------------------------------------------------
      - name: üß™ Run unit tests
        run: npm run test -- --run || true
        continue-on-error: true

      # -----------------------------------------------------------------------
      # Step 6: Calculate Version
      # -----------------------------------------------------------------------
      - name: üè∑Ô∏è Calculate version
        id: version
        run: |
          # Get latest tag (ignore pre-releases)
          LATEST_TAG=$(git tag --list 'v*' --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
          if [[ -z "$LATEST_TAG" ]]; then
            MAJOR=1; MINOR=0; PATCH=0
          else
            TAG_NO_V=${LATEST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$TAG_NO_V"
          fi

          # Increment patch by default
          PATCH=$((PATCH+1))

          # If patch > 9, increment minor and reset patch
          if [[ $PATCH -gt 9 ]]; then
            PATCH=0
            MINOR=$((MINOR+1))
          fi

          # If minor > 9, increment major and reset minor/patch
          if [[ $MINOR -gt 9 ]]; then
            MINOR=0
            MAJOR=$((MAJOR+1))
          fi

          VERSION="$MAJOR.$MINOR.$PATCH"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "üì¶ Version: ${VERSION}"

      # -----------------------------------------------------------------------
      # Step 7: Update Version in Environment Files
      # -----------------------------------------------------------------------
      - name: üìù Update version in environment files
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Update version placeholder in environment files
          sed -i "s/\${VERSION}/${VERSION}/g" src/environments/environment.dev.ts
          sed -i "s/\${VERSION}/${VERSION}/g" src/environments/environment.uat.ts
          sed -i "s/\${VERSION}/${VERSION}/g" src/environments/environment.prod.ts

          echo "‚úÖ Updated environment files with version: ${VERSION}"

      # -----------------------------------------------------------------------
      # Step 8: Build for DEV Environment
      # -----------------------------------------------------------------------
      - name: üèóÔ∏è Build for DEV environment
        run: |
          npm run build -- --configuration=development --base-href="/srt-learning-cicd-ng/dev/"

      # -----------------------------------------------------------------------
      # Step 9: Upload Build Artifacts
      # -----------------------------------------------------------------------
      - name: üì§ Prepare DEV artifact for GitHub Pages
        run: |
          mkdir -p github-pages-artifact/dev
          cp -r dist/srt-learning-cicd-ng/browser/* github-pages-artifact/dev/
      - name: üì§ Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages-artifact
          path: github-pages-artifact

  # ===========================================================================
  # Job: Deploy to DEV (GitHub Pages)
  # ===========================================================================
  deploy-dev:
    name: üöÄ Deploy to DEV
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    # GitHub Pages specific permissions
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: DEV
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Download Build Artifacts
      # -----------------------------------------------------------------------
      - name: üì• Download DEV artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages-artifact
          path: github-pages-artifact
      - name: üìÑ Setup Pages
        uses: actions/configure-pages@v4
      - name: üì§ Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: github-pages-artifact
      - name: üåê Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # -----------------------------------------------------------------------
      # Step 5: Deployment Summary
      # -----------------------------------------------------------------------
      - name: üìã Deployment summary
        run: |
          echo "## üöÄ DEV Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build-and-test.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** DEV" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
                    echo "**DEV URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Review changes in DEV environment" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger UAT deployment when ready (requires QA approval)" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job: Create Version Tag
  # ===========================================================================
  create-version-tag:
    name: üè∑Ô∏è Create Version Tag
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-dev]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Create and push tag
        run: |
          VERSION="${{ needs.build-and-test.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${VERSION}" -m "Release version ${VERSION}"
          git push origin "v${VERSION}" || echo "Tag push failed - may already exist or lack permissions"

          echo "## üè∑Ô∏è Version Tagged" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** v${VERSION}" >> $GITHUB_STEP_SUMMARY
